STUN 协议分析
================

:Date: 11/30 2016

.. contents::

协议简介
----------


报文结构
-----------

`STUN` 数据包由 一个 `报文头部` 以及 零至多个 `报文属性` 组成。


头部
~~~~~~~~

`STUN` 数据包头部包含了 `Message Type` 、 `Message Length` 、 `Magic Cookie` 、 `Transaction ID` ，如下::

	 0                   1                   2                   3
	 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	|0 0|     STUN Message Type     |         Message Length        |
	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	|                         Magic Cookie                          |
	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	|                                                               |
	|                     Transaction ID (96 bits)                  |
	|                                                               |
	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


*Message Type (14 bits):* 前面 2 bits 表示 `Message Class` ，后面 12 bits 表示 `Message Method` 。

*Message Length ( 16 bits ) :* 报文属性长度（不包括头部，指下面的报文属性）。

*Magic Cookie ( 32 bits ) :* 字段包含固定值 `0x2112A442`

*Transaction ID ( 96 bits ) :* 具有唯一性的事务编号。

.. Note::
	
	注： 在 `rfc3489 <http://www.rfc-editor.org/info/rfc3489>`_ 当中，
	`MgaicCookie` 和 `TransactionID` 属于一个字段，长度为 128 bits 。


属性
~~~~~~~~~

在 `STUN` 报文头部之后，通常跟着0个或者多个属性，每个属性必须是TLV编码的（Type-Length-Value）。
其中 `Type` 字段和 `Length` 字段都是 16 位，`Value` 字段为 32 位表示，如下::

	 0                   1                   2                   3
	0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	|         Type                  |            Length             |
	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	|                         Value (variable)                ....
	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


不同的 `属性类型 (Type)` 产生不同的 `属性变量值 (Value)` 。下面是几个常见 `属性变量值` 结构:


`MAPPED-ADDRESS` ::
	
	 0                   1                   2                   3
	 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	|0 0 0 0 0 0 0 0|    Family     |           Port                |
	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	|                                                               |
	|                 Address (32 bits or 128 bits)                 |
	|                                                               |
	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


`XOR-MAPPED-ADDRESS` ::

	 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
	 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	 |x x x x x x x x|    Family     |         X-Port                |
	 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	 |                X-Address (Variable)
	 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


`ERROR-CODE` ::

  	 0                   1                   2                   3
	0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	|           Reserved, should be 0         |Class|     Number    |
	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	|      Reason Phrase (variable)                                ..
	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


1. 21 bits
2.  3 bits ( error_code/100 )
3.  8 bits ( error_code % 100 )
4.  reason ...

其它更多的属性请查阅 `RFC` 文档。


通信过程
-----------

**TODO**


参考
-----------

*	`RFC3489 <http://www.rfc-editor.org/info/rfc3489>`_ , STUN
*	`RFC5389 <http://www.rfc-editor.org/info/rfc5389>`_ , STUN
*	`RFC5766 <http://www.rfc-editor.org/info/rfc5766>`_ , STUN
*	`RFC5245 <http://www.rfc-editor.org/info/rfc5245>`_ , ICE
*	`RFC7064 <https://tools.ietf.org/html/rfc7064>`_ , URI Scheme for STUN




